/*
 * secureApplication.c
 *
 *  Created on: Feb 21, 2023
 *      Author: nxf63523
 */

#include "secureApplication.h"
#include "secureLayer.h"
#include "FreeRTOS.h"

static void secureTCP_Client(void){
	uint16_t securePort = 10000;
	ip4_addr_t server_ipaddr, server_netmask, server_gw;
	SecureConnPtr sec_conn;
	uint8_t MessageBuffer1[32] = {
				0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
				0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
				0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
				0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
		};
		uint8_t MessageBuffer2[32] = {
				0x00, 0x44, 0x02, 0x54, 0x04, 0x05, 0x06, 0x07,
				0x08, 0x55, 0x43, 0x0B, 0x0C, 0xFF, 0x0E, 0x0F,
				0x00, 0x66, 0x11, 0x28, 0x23, 0x05, 0x06, 0x94,
				0x08, 0x32, 0x0A, 0x0B, 0x0C, 0xCC, 0x0E, 0x0F,
		};
		uint8_t MessageBuffer3[32] = {
				0x00, 0x23, 0x02, 0x43, 0x04, 0x12, 0x06, 0x13,
				0xFF, 0x12, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
				0x00, 0x32, 0x02, 0x56, 0x04, 0x43, 0x06, 0x91,
				0x41, 0x09, 0x31, 0x0B, 0x89, 0x0D, 0x45, 0x0F,
		};
		uint8_t MessageBuffer4[32] = {
				0x44, 0x01, 0x02, 0x03, 0x04, 0xDD, 0x06, 0x07,
				0x08, 0x09, 0xFB, 0x0B, 0xCF, 0x0D, 0xFE, 0xFF,
				0x22, 0x38, 0x02, 0x52, 0x04, 0xF5, 0x06, 0x07,
				0x08, 0x09, 0xBA, 0x0B, 0xCD, 0x0D, 0x0E, 0xFF,
		};
		uint8_t MessageBuffer5[32] = {
				0x00, 0x23, 0x02, 0x43, 0x04, 0x12, 0x06, 0x13,
				0xFF, 0x12, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
				0x22, 0x38, 0x02, 0x52, 0x04, 0xF5, 0x06, 0x07,
				0x08, 0x09, 0xBA, 0x0B, 0xCD, 0x0D, 0x0E, 0xFF,
		};
		uint8_t MessageBuffer6[32] = {
				0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
				0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
				0x00, 0x23, 0x02, 0x43, 0x04, 0x12, 0x06, 0x13,
				0xFF, 0x12, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F
		};
		uint8_t MessageBuffer7[32] = {
				0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
				0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
				0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
				0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
		};
		uint8_t MessageBuffer8[32] = {
				0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
				0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
				0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
				0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		};
	void* ReceiveBuffer;
	uint16_t receivedLength;

	IP4_ADDR(&server_ipaddr, 192, 168, 0, 100);
	IP4_ADDR(&server_netmask, 255, 255, 255, 0);
	IP4_ADDR(&server_gw, 192, 168, 0, 102);

	sec_conn = initSecureConnection(secureClient, &server_ipaddr, securePort);

	secureTransmit(sec_conn, MessageBuffer1, 32);
	secureReceive(sec_conn, ReceiveBuffer, &receivedLength);

	secureTransmit(sec_conn, MessageBuffer2, 32);
	secureReceive(sec_conn, ReceiveBuffer, &receivedLength);

	secureTransmit(sec_conn, MessageBuffer3, 32);
	secureReceive(sec_conn, ReceiveBuffer, &receivedLength);

	secureTransmit(sec_conn, MessageBuffer4, 32);
	secureReceive(sec_conn, ReceiveBuffer, &receivedLength);

	secureTransmit(sec_conn, MessageBuffer5, 32);
	secureReceive(sec_conn, ReceiveBuffer, &receivedLength);

	secureTransmit(sec_conn, MessageBuffer6, 32);
	secureReceive(sec_conn, ReceiveBuffer, &receivedLength);

	secureTransmit(sec_conn, MessageBuffer7, 32);
	secureReceive(sec_conn, ReceiveBuffer, &receivedLength);

	secureTransmit(sec_conn, MessageBuffer8, 32);
	secureReceive(sec_conn, ReceiveBuffer, &receivedLength);

	deinitSecureConnection(sec_conn);
}

static void secureTCP_Server(void){
	uint8_t securePort = 7;
	ip4_addr_t server_ipaddr, server_netmask, server_gw;
	SecureConnPtr sec_conn;

	void* ReceiveBuffer;
	uint16_t receivedLength;

	sec_conn = initSecureConnection(secureServer, NULL, securePort);

	secureReceive(sec_conn, ReceiveBuffer, &receivedLength);

	secureTransmit(sec_conn, (uint8_t*)ReceiveBuffer, receivedLength);

	deinitSecureConnection(sec_conn);
}

void initSecureTCP_Client(void){
	BaseType_t xResult;
	TaskHandle_t xCreatedTask;

	xResult = xTaskCreate(secureTCP_Client, "Secure Client", (configSTACK_DEPTH_TYPE)1000, NULL, 3, &xCreatedTask);
	while(xResult != pdPASS)
	{
		// Do nothing
	}
}
void initSecureTCP_Server(void){
	BaseType_t xResult;
	TaskHandle_t xCreatedTask;

	xResult = xTaskCreate(secureTCP_Server, "Secure Server", (configSTACK_DEPTH_TYPE)1000, NULL, 3, &xCreatedTask);
	while(xResult != pdPASS)
	{
		// Do nothing
	}
}

